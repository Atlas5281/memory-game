<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>FUNNER Flip Game</title>
  <style>
    /* å…¨å±€è¨­å®š */
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
    html, body { width: 100%; height: 100%; overflow: hidden; background-color: #1a1a1a; }
    body { font-family: "Microsoft JhengHei", sans-serif; display: flex; justify-content: center; align-items: center; color: #fff; }

    /* ç•«é¢å®¹å™¨ */
    .screen {
      position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
      display: none; flex-direction: column; align-items: center;
      background-size: cover; background-position: center; background-repeat: no-repeat;
    }

    /* --- 1. å•Ÿå‹•ç•«é¢ --- */
    #loginScreen { display: flex; z-index: 2000; background-image: url("./assets/ui/login_bg.png"); cursor: pointer; }
    .tap-hint {
      position: absolute; left: 50%; transform: translateX(-50%);
      bottom: 20%; color: #fff; font-size: 1.5rem; font-weight: bold; letter-spacing: 2px;
      animation: blink 2s infinite; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }

    /* --- 2. ä¸»é¸å–® (UI é‡æ§‹ç‰ˆ) --- */
    #mainMenu { 
      background-image: url("./assets/ui/login_bg.png"); 
    }
    
    /* === ä¿®æ­£é‡é»ï¼šPLAY æŒ‰éˆ• === */
    .main-play-btn {
      position: absolute;
      left: 50%;
      transform: translateX(-50%); /* åªåšæ°´å¹³å±…ä¸­ */
      
      /* ä½ç½®æ§åˆ¶ï¼šæ•¸å­—è¶Šå°è¶Šé åº•ï¼Œé¿é–‹ä¸Šæ–¹ Logo */
      bottom: 22%; 
      
      /* å¤§å°æ§åˆ¶ï¼šåŸæœ¬å¤ªå°ï¼Œç¾åœ¨è¨­ç‚ºè¢å¹•å¯¬åº¦çš„ 50% */
      width: 50vw; 
      max-width: 280px; /* é›»è…¦ç‰ˆæœ€å¤§é™åˆ¶ */
      height: auto;
      
      cursor: pointer;
      transition: transform 0.1s;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); /* å¢åŠ é™°å½±è®“å®ƒæµ®èµ·ä¾† */
      z-index: 100;
    }
    .main-play-btn:active { transform: translateX(-50%) scale(0.95); }

    /* === ä¿®æ­£é‡é»ï¼šåº•éƒ¨åŠŸèƒ½åˆ— === */
    .dock-container {
      position: absolute; 
      bottom: 4%; /* ç·Šè²¼åº•éƒ¨ */
      width: 100%;
      display: flex; 
      justify-content: center; /* æ°´å¹³æ’åˆ—å±…ä¸­ */
      gap: 15px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
      padding-bottom: 10px;
      z-index: 100;
    }

    .dock-btn {
      /* å¤§å°æ§åˆ¶ï¼šåŠ å¤§åˆ° 28vwï¼Œç¢ºä¿æ‰‹æ©Ÿå¥½é»æ“Š */
      width: 28vw; 
      max-width: 120px; 
      height: auto;
      cursor: pointer;
      transition: transform 0.2s;
      filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5));
    }
    .dock-btn:active { transform: scale(0.9); }
    /* ç•¶å‰é é¢åœ–ç¤ºç¨å¾®äº®ä¸€é» */
    .dock-btn.active { filter: brightness(1.2) drop-shadow(0 0 8px rgba(255,255,255,0.3)); }


    /* --- 3. éŠæˆ²ç•«é¢ --- */
    #gameArea { background-color: #222; }
    .nav-bar {
      width: 100%; height: 60px; display: flex; justify-content: space-between; align-items: center;
      padding: 0 15px; background: #333; border-bottom: 1px solid #444; color: #fff;
    }
    .version-tag { font-size: 12px; color: #666; cursor: pointer; padding: 10px; }
    .settings-btn { font-size: 22px; cursor: pointer; padding: 5px; }

    #cardGrid {
      display: grid; gap: 8px; padding: 15px; width: 100vw; max-width: 450px;
      margin: auto; justify-content: center; align-content: center; flex-grow: 1;
    }
    .card { position: relative; cursor: pointer; aspect-ratio: 1 / 1; width: 100%; }
    .card-inner { width: 100%; height: 100%; transition: transform 0.5s; transform-style: preserve-3d; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; border: 1px solid #444; }
    .card-back { background: url("./assets/ui/card_back.jpg") center/cover; }
    .card-front { transform: rotateY(180deg); background: #fff; overflow: hidden; }
    .card-front img { width: 100%; height: 100%; object-fit: cover; }
    
    .center-card { cursor: default !important; border: 2px dashed #555 !important; background: rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; border-radius: 12px; }
    .center-card::after { content: "ğŸ”’"; font-size: 1.5rem; opacity: 0.3; }

    /* --- 4. åœ–é‘‘ & æ’è¡Œæ¦œç•«é¢ --- */
    #galleryScreen, #leaderboardScreen { background-color: #1a1a1a; padding-top: 70px; overflow-y: auto; display: none; }
    .header-bar { position: fixed; top: 0; width: 100%; height: 60px; background: #333; display: flex; align-items: center; justify-content: center; z-index: 100; border-bottom: 1px solid #444; font-weight: bold; font-size: 18px; }
    .close-icon { position: absolute; right: 20px; font-size: 24px; cursor: pointer; }

    /* åœ–é‘‘ Grid */
    .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; max-width: 500px; margin: 0 auto; }
    .gallery-item { aspect-ratio: 1/1; background: #2a2a2a; border-radius: 10px; border: 2px solid #333; overflow: hidden; position: relative; }
    .gallery-item.locked::after { content: "?"; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color: #555; font-size: 24px; }
    .gallery-item.unlocked { border-color: #ffd700; cursor: pointer; }
    .gallery-item img { width: 100%; height: 100%; display: none; object-fit: cover; }
    .gallery-item.unlocked img { display: block; }

    /* æ’è¡Œæ¦œ List */
    .rank-list { width: 90%; max-width: 400px; background: #2a2a2a; border-radius: 15px; padding: 20px; margin: 20px auto; }
    .rank-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #444; font-size: 14px; }
    .rank-header { color: #ffd700; border-bottom: 2px solid #ffd700; font-weight: bold; }

    /* å½ˆçª— */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 5000; }
    .modal { background: #333; padding: 25px; border-radius: 20px; text-align: center; width: 80%; max-width: 320px; border: 1px solid #555; }
    .modal h3 { color: #ffd700; margin-bottom: 15px; }
    .modal-btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #007AFF; color: #fff; }
    .btn-danger { background: #ff453a; color: #fff; }
    .btn-close { background: #444; color: #ccc; }

    @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
  </style>
</head>
<body>

  <div id="loginScreen" class="screen" onclick="gotoMenu()">
    <div class="tap-hint">TAP TO START</div>
  </div>

  <div id="mainMenu" class="screen">
    
    <img src="./assets/ui/play_btn.png" class="main-play-btn" onclick="gotoGame()">

    <div class="dock-container">
      <img src="./assets/ui/gallery_btn.png" class="dock-btn" onclick="openGallery()">
      <img src="./assets/ui/home_btn.png" class="dock-btn active"> 
      <img src="./assets/ui/rank_btn.png" class="dock-btn" onclick="openLeaderboard()">
    </div>

  </div>

  <div id="galleryScreen" class="screen">
    <div class="header-bar">ç”Ÿç‰©åœ–é‘‘<div class="close-icon" onclick="backToMenu()">Ã—</div></div>
    <div id="galleryGrid" class="gallery-grid"></div>
  </div>

  <div id="leaderboardScreen" class="screen">
    <div class="header-bar">æ¦®è­½æ’è¡Œæ¦œ<div class="close-icon" onclick="backToMenu()">Ã—</div></div>
    <div class="rank-list" id="rankList">
      <div class="rank-row rank-header"><span>æ’å / ç©å®¶</span><span>æ­¥æ•¸ / æ™‚é–“</span></div>
      <div style="text-align:center; padding:20px; color:#666;">æš«ç„¡ç´€éŒ„</div>
    </div>
  </div>

  <div id="gameArea" class="screen">
    <div class="nav-bar">
      <div class="version-tag" onclick="handleDevClick()">v1.0.0</div>
      <div style="font-weight:bold; color:#ffd700;">LEVEL <span id="lvText">1</span></div>
      <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>
    </div>
    <div id="cardGrid"></div>
    <div style="color:#888; padding-bottom:20px; font-weight:bold;">STEPS: <span id="stText">0</span></div>
  </div>

  <div id="settingsOverlay" class="overlay">
    <div class="modal">
      <h3>ç³»çµ±è¨­å®š</h3>
      <button class="modal-btn btn-primary" onclick="toggleAudio()">éŸ³æ•ˆ: <span id="audioStatus">ON</span></button>
      <button class="modal-btn btn-danger" onclick="confirmExit()">è¿”å›ä¸»é¸å–®</button>
      <button class="modal-btn btn-close" onclick="closeOverlay()">ç¹¼çºŒéŠæˆ²</button>
    </div>
  </div>

  <div id="infoOverlay" class="overlay">
    <div class="modal">
      <h3 id="infoName">???</h3>
      <img id="infoImg" src="" style="width:100px; height:100px; object-fit:cover; border-radius:10px; margin:10px auto; display:block;">
      <p>é¦–æ¬¡ç²å¾—ï¼š<br><span id="infoDate" style="color:#ffd700;">---</span></p>
      <button class="modal-btn btn-close" onclick="closeOverlay()">é—œé–‰</button>
    </div>
  </div>

  <div id="winOverlay" class="overlay">
    <div class="modal">
      <h2 style="color:#ffd700; margin-bottom:10px;">LEVEL CLEAR!</h2>
      <p>æ¶ˆè€—æ­¥æ•¸ï¼š<span id="finalSt">0</span></p>
      <button class="modal-btn btn-primary" onclick="nextLevel()">ä¸‹ä¸€é—œ</button>
    </div>
  </div>

  <audio id="bgm" src="./assets/audio/theme.mp3" loop></audio>

  <script>
    /* è®Šæ•¸å®£å‘Š */
    let lv = 1, st = 0, matched = 0, flipped = [], lock = false;
    let devClickCount = 0, devTimer = null;
    const totalFish = 18;
    const fishDB = ["å°ä¸‘é­š","è—å€’åŠ","é»ƒä¸‰è§’","ç…å­é­š","æµ·é¦¬","æ°´æ¯","æµ·é¾œ","é¯¨é¯Š","é­Ÿé­š","ç« é­š","é¾è¦","æµ·æ˜Ÿ","æ²³è±š","æ¯”ç›®é­š","ç¥ä»™é­š","è¶é­š","é®ªé­š","ç¥ç§˜æ·±æµ·é­š"];

    /* é é¢åˆ‡æ› */
    function gotoMenu() { switchScreen('mainMenu'); playBgm(); }
    function gotoGame() { switchScreen('gameArea'); lv = 1; initLevel(); }
    function backToMenu() { switchScreen('mainMenu'); }
    
    function switchScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
      const target = document.getElementById(id);
      target.style.display = (id === 'galleryScreen' || id === 'leaderboardScreen') ? 'block' : 'flex';
    }

    /* é–‹ç™¼è€…æ¨¡å¼ (å·¦ä¸Šè§’é€£é»5æ¬¡) */
    function handleDevClick() {
      devClickCount++; clearTimeout(devTimer);
      if(devClickCount >= 5) { devClickCount = 0; alert("âš¡ é–‹ç™¼è€…æ¨¡å¼ï¼šè·³é—œæˆåŠŸï¼"); showWin(); }
      devTimer = setTimeout(() => devClickCount = 0, 2000);
    }

    /* è¨­å®š & éŸ³æ•ˆ */
    function openSettings() { document.getElementById('settingsOverlay').style.display = 'flex'; }
    function closeOverlay() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); }
    function confirmExit() { if(confirm("è¿”å›ä¸»é¸å–®ï¼Ÿé€²åº¦å°‡éºå¤±")) { closeOverlay(); backToMenu(); } }
    function toggleAudio() {
      const bgm = document.getElementById('bgm');
      if(bgm.paused) { bgm.play(); document.getElementById('audioStatus').textContent = "ON"; }
      else { bgm.pause(); document.getElementById('audioStatus').textContent = "OFF"; }
    }
    function playBgm() { document.getElementById('bgm').play().catch(()=>{}); }

    /* åœ–é‘‘ç³»çµ± */
    function openGallery() {
      switchScreen('galleryScreen');
      const grid = document.getElementById('galleryGrid'); grid.innerHTML = '';
      const collection = JSON.parse(localStorage.getItem('funner_collection') || '{}');
      for(let i=1; i<=totalFish; i++) {
        const item = document.createElement('div');
        const unlocked = collection[i];
        item.className = `gallery-item ${unlocked ? 'unlocked' : 'locked'}`;
        item.innerHTML = `<img src="./assets/cards/${i}.jpg">`;
        item.onclick = () => {
          if(unlocked) {
            document.getElementById('infoName').textContent = fishDB[i-1] || `ç”Ÿç‰© ${i}`;
            document.getElementById('infoImg').src = `./assets/cards/${i}.jpg`;
            document.getElementById('infoDate').textContent = unlocked;
            document.getElementById('infoOverlay').style.display = 'flex';
          }
        };
        grid.appendChild(item);
      }
    }
    function unlockGalleryItem(idx) {
      let col = JSON.parse(localStorage.getItem('funner_collection') || '{}');
      if(!col[idx]) { col[idx] = new Date().toLocaleDateString(); localStorage.setItem('funner_collection', JSON.stringify(col)); }
    }

    /* æ’è¡Œæ¦œç³»çµ± */
    function openLeaderboard() {
      switchScreen('leaderboardScreen');
      const list = document.getElementById('rankList');
      list.innerHTML = `<div class="rank-row rank-header"><span>æ’å / ç©å®¶</span><span>æ­¥æ•¸ / æ™‚é–“</span></div>`;
      let recs = JSON.parse(localStorage.getItem('funner_leaderboard') || '[]');
      if(recs.length === 0) { list.innerHTML += `<div style="text-align:center; padding:20px; color:#666;">æš«ç„¡ç´€éŒ„</div>`; return; }
      recs.forEach((r, idx) => {
        let c = idx===0?'#ffd700':(idx===1?'#c0c0c0':(idx===2?'#cd7f32':'#fff'));
        list.innerHTML += `<div class="rank-row"><span style="color:${c}">#${idx+1} ${r.name}</span><span style="font-size:12px; color:#aaa;">${r.steps}æ­¥</span></div>`;
      });
    }
    function saveRank(steps) {
      let recs = JSON.parse(localStorage.getItem('funner_leaderboard') || '[]');
      const name = prompt("æ­å–œé€šé—œï¼è«‹è¼¸å…¥åå­—ç´€éŒ„æ’è¡Œï¼š", "Player") || "ç„¡åæ°";
      recs.push({ name, steps, time: Date.now() });
      recs.sort((a,b) => a.steps - b.steps || a.time - b.time);
      localStorage.setItem('funner_leaderboard', JSON.stringify(recs.slice(0,10)));
    }

    /* éŠæˆ²æ ¸å¿ƒ */
    function initLevel() {
      const grid = document.getElementById('cardGrid'); grid.innerHTML = '';
      st = 0; matched = 0; flipped = []; lock = false;
      document.getElementById('stText').textContent = st; document.getElementById('lvText').textContent = lv;
      let size = (lv===1)?4:(lv===2?5:6);
      let pairs = (lv===2)?(size*size-1)/2 : size*size/2;
      let deck = Array.from({length:18},(_,i)=>i+1).sort(()=>0.5-Math.random()).slice(0,pairs);
      deck = [...deck,...deck].sort(()=>0.5-Math.random());
      grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

      for(let i=0; i<size*size; i++) {
        const card = document.createElement('div');
        if(lv===2 && i===12) { card.className='card center-card'; grid.appendChild(card); continue; }
        const idx = deck.pop();
        card.className = 'card';
        card.innerHTML = `<div class="card-inner"><div class="card-face card-back"></div><div class="card-face card-front"><img src="./assets/cards/${idx}.jpg"></div></div>`;
        card.onclick = () => {
          if(lock || card.classList.contains('flipped')) return;
          card.classList.add('flipped'); flipped.push({card, idx});
          if(flipped.length===2) {
            st++; document.getElementById('stText').textContent = st; lock=true;
            if(flipped[0].idx === flipped[1].idx) {
              matched++; unlockGalleryItem(flipped[0].idx); flipped=[]; lock=false;
              if(matched===pairs) setTimeout(showWin, 500);
            } else { setTimeout(()=>{ flipped.forEach(f=>f.card.classList.remove('flipped')); flipped=[]; lock=false; }, 800); }
          }
        };
        grid.appendChild(card);
      }
    }
    function showWin() {
      document.getElementById('finalSt').textContent = st; document.getElementById('winOverlay').style.display = 'flex';
      if(lv===3) saveRank(st);
    }
    function nextLevel() {
      document.getElementById('winOverlay').style.display = 'none';
      if(lv<3) { lv++; initLevel(); } else { backToMenu(); }
    }
  </script>
</body>
</html>